{"version":3,"file":"index.jsm","sources":["../src/loop.ts","../src/index.ts"],"sourcesContent":["import { Clock, ClockType } from '@four/clock'\n\nconst finished = Promise.resolve()\n\ntype RequestImmediate = (handler: () => void) => NodeJS.Immediate | number\ntype CancelImmediate = (immediate: NodeJS.Immediate | number) => void\n\nlet requestImmediate: RequestImmediate | undefined\nlet cancelImmediate: CancelImmediate | undefined\n\nif (\n  typeof requestAnimationFrame === 'function' &&\n  typeof cancelAnimationFrame === 'function'\n) {\n  requestImmediate = requestAnimationFrame\n  cancelImmediate = cancelAnimationFrame as CancelImmediate\n} else if (\n  typeof setImmediate === 'function' &&\n  typeof clearImmediate === 'function'\n) {\n  requestImmediate = setImmediate\n  cancelImmediate = clearImmediate as CancelImmediate\n}\n\nexport type LoopType = 'immediate' | 'interval'\n\nexport class Loop {\n  private resolve?: () => void\n  private immediateID?: NodeJS.Immediate | number\n  private intervalID?: NodeJS.Timeout\n  private throttle = Clock.throttle(() => this.interval)\n  public handlers: Set<(clock: Clock) => void> = new Set()\n  public interval: number\n  public fixed: boolean\n  public type: LoopType\n  public running: boolean = false\n  public promise: Promise<void> = finished\n  public readonly handler = () => this.tick()\n  public clock: Clock\n\n  public static async delay(duration: number): Promise<void> {\n    await new Promise(resolve => setTimeout(resolve, duration))\n  }\n\n  public static async repeat(\n    interval: number,\n    handler: (clock: Clock) => boolean | void\n  ): Promise<void> {\n    const loop = new this({ interval, type: 'interval' })\n    const repeat = loop.repeat(handler)\n\n    loop.start()\n    await repeat\n    loop.stop()\n  }\n\n  public constructor(parameters?: {\n    interval?: number\n    fixed?: boolean\n    type?: LoopType\n    clockType?: ClockType\n  })\n  public constructor(parameters?: {\n    interval?: number\n    fixed?: boolean\n    type?: LoopType\n    clock?: Clock\n  })\n  public constructor({\n    interval = 0,\n    fixed = false,\n    type = 'immediate',\n    clockType = undefined,\n    clock = new Clock({ type: clockType })\n  }: {\n    interval?: number\n    fixed?: boolean\n    type?: 'immediate' | 'interval'\n    clockType?: ClockType\n    clock?: Clock\n  } = {}) {\n    this.type = type\n    this.interval = interval\n    this.fixed = fixed\n    this.clock = clock\n    this.clock.interval = (delta: number) => this.fixed\n      ? this.interval\n      : this.throttle(delta)\n  }\n\n  private requestImmediate = (): void => {\n    this.tick()\n    this.immediateID = requestImmediate!(this.requestImmediate)\n  }\n\n  private cancelImmediate(): void {\n    cancelImmediate!(this.immediateID!)\n    this.immediateID = undefined\n  }\n\n  private requestInterval = (): void => {\n    this.tick()\n    this.intervalID = setInterval(this.handler, this.interval || 1)\n  }\n\n  private cancelInterval = (): void => {\n    clearInterval(this.intervalID!)\n    this.intervalID = undefined\n  }\n\n  protected request(): void {\n    this.type === 'immediate' && requestImmediate\n      ? this.requestImmediate()\n      : this.requestInterval()\n  }\n\n  protected cancel(): void {\n    this.type === 'immediate' && cancelImmediate\n      ? this.cancelImmediate()\n      : this.cancelInterval()\n  }\n\n  public async delay(duration: number): Promise<void> {\n    duration += this.clock.elapsed\n    return this.repeat(clock => clock.elapsed <= duration)\n  }\n\n  public async repeat(\n    handler: (clock: Clock) => boolean | void\n  ): Promise<void> {\n    return new Promise((resolve) => {\n      const repeat = (clock: Clock): void => {\n        if (handler(clock) !== false) return\n        this.remove(repeat)\n        resolve()\n      }\n\n      this.add(repeat)\n    })\n  }\n\n  public add(handler: (clock: Clock) => void): this {\n    this.handlers.add(handler)\n    return this\n  }\n\n  public remove(handler: (clock: Clock) => void): this {\n    this.handlers.delete(handler)\n    return this\n  }\n\n  public tick(): this {\n    const clock = this.clock.tick()\n    clock.delta && this.handlers.forEach(handler => handler(clock))\n    return this\n  }\n\n  public start(): this {\n    if (!this.running) {\n      this.running = true\n      this.promise = new Promise((resolve) => { this.resolve = resolve })\n      this.clock.reset()\n      this.request()\n    }\n\n    return this\n  }\n\n  public stop(): this {\n    if (this.running) {\n      this.cancel()\n      this.resolve!()\n      this.running = false\n      this.promise = finished\n    }\n\n    return this\n  }\n\n  public reset(): this {\n    this.clock.reset(true)\n    return this\n  }\n}\n","import { Clock } from '@four/clock'\nimport { Loop, LoopType } from './loop'\n\nexport { Loop, LoopType }\n\nexport function delay(duration: number): Promise<void> {\n  return Loop.delay(duration)\n}\n\nexport function repeat(\n  interval: number,\n  handler: (clock: Clock) => boolean | void\n): Promise<void> {\n  return Loop.repeat(interval, handler)\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,MAAM,QAAQ,GAAG,OAAO,CAAC,OAAO,EAAE,CAAA;AAKlC,IAAI,gBAA8C,CAAA;AAClD,IAAI,eAA4C,CAAA;AAEhD,IACE,OAAO,qBAAqB,KAAK,UAAU;IAC3C,OAAO,oBAAoB,KAAK,UAAU,EAC1C;IACA,gBAAgB,GAAG,qBAAqB,CAAA;IACxC,eAAe,GAAG,oBAAuC,CAAA;CAC1D;KAAM,IACL,OAAO,YAAY,KAAK,UAAU;IAClC,OAAO,cAAc,KAAK,UAAU,EACpC;IACA,gBAAgB,GAAG,YAAY,CAAA;IAC/B,eAAe,GAAG,cAAiC,CAAA;CACpD;MAIY,IAAI;IA0Cf,YAAmB,EACjB,QAAQ,GAAG,CAAC,EACZ,KAAK,GAAG,KAAK,EACb,IAAI,GAAG,WAAW,EAClB,SAAS,GAAG,SAAS,EACrB,KAAK,GAAG,IAAI,KAAK,CAAC,EAAE,IAAI,EAAE,SAAS,EAAE,CAAC,KAOpC,EAAE;QAlDE,aAAQ,GAAG,KAAK,CAAC,QAAQ,CAAC,MAAM,IAAI,CAAC,QAAQ,CAAC,CAAA;QAC/C,aAAQ,GAAgC,IAAI,GAAG,EAAE,CAAA;QAIjD,YAAO,GAAY,KAAK,CAAA;QACxB,YAAO,GAAkB,QAAQ,CAAA;QACxB,YAAO,GAAG,MAAM,IAAI,CAAC,IAAI,EAAE,CAAA;QAqDnC,qBAAgB,GAAG;YACzB,IAAI,CAAC,IAAI,EAAE,CAAA;YACX,IAAI,CAAC,WAAW,GAAG,gBAAiB,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAA;SAC5D,CAAA;QAOO,oBAAe,GAAG;YACxB,IAAI,CAAC,IAAI,EAAE,CAAA;YACX,IAAI,CAAC,UAAU,GAAG,WAAW,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,QAAQ,IAAI,CAAC,CAAC,CAAA;SAChE,CAAA;QAEO,mBAAc,GAAG;YACvB,aAAa,CAAC,IAAI,CAAC,UAAW,CAAC,CAAA;YAC/B,IAAI,CAAC,UAAU,GAAG,SAAS,CAAA;SAC5B,CAAA;QA3BC,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;QAChB,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAA;QACxB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAA;QAClB,IAAI,CAAC,KAAK,GAAG,KAAK,CAAA;QAClB,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG,CAAC,KAAa,KAAK,IAAI,CAAC,KAAK;cAC/C,IAAI,CAAC,QAAQ;cACb,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAA;KACzB;IAhDM,OAAa,KAAK,CAAC,QAAgB;;YACxC,MAAM,IAAI,OAAO,CAAC,OAAO,IAAI,UAAU,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC,CAAA;SAC5D;KAAA;IAEM,OAAa,MAAM,CACxB,QAAgB,EAChB,OAAyC;;YAEzC,MAAM,IAAI,GAAG,IAAI,IAAI,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC,CAAA;YACrD,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,CAAA;YAEnC,IAAI,CAAC,KAAK,EAAE,CAAA;YACZ,MAAM,MAAM,CAAA;YACZ,IAAI,CAAC,IAAI,EAAE,CAAA;SACZ;KAAA;IAyCO,eAAe;QACrB,eAAgB,CAAC,IAAI,CAAC,WAAY,CAAC,CAAA;QACnC,IAAI,CAAC,WAAW,GAAG,SAAS,CAAA;KAC7B;IAYS,OAAO;QACf,IAAI,CAAC,IAAI,KAAK,WAAW,IAAI,gBAAgB;cACzC,IAAI,CAAC,gBAAgB,EAAE;cACvB,IAAI,CAAC,eAAe,EAAE,CAAA;KAC3B;IAES,MAAM;QACd,IAAI,CAAC,IAAI,KAAK,WAAW,IAAI,eAAe;cACxC,IAAI,CAAC,eAAe,EAAE;cACtB,IAAI,CAAC,cAAc,EAAE,CAAA;KAC1B;IAEY,KAAK,CAAC,QAAgB;;YACjC,QAAQ,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,CAAA;YAC9B,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,IAAI,KAAK,CAAC,OAAO,IAAI,QAAQ,CAAC,CAAA;SACvD;KAAA;IAEY,MAAM,CACjB,OAAyC;;YAEzC,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO;gBACzB,MAAM,MAAM,GAAG,CAAC,KAAY;oBAC1B,IAAI,OAAO,CAAC,KAAK,CAAC,KAAK,KAAK;wBAAE,OAAM;oBACpC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAA;oBACnB,OAAO,EAAE,CAAA;iBACV,CAAA;gBAED,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAA;aACjB,CAAC,CAAA;SACH;KAAA;IAEM,GAAG,CAAC,OAA+B;QACxC,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC,CAAA;QAC1B,OAAO,IAAI,CAAA;KACZ;IAEM,MAAM,CAAC,OAA+B;QAC3C,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,OAAO,CAAC,CAAA;QAC7B,OAAO,IAAI,CAAA;KACZ;IAEM,IAAI;QACT,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,CAAA;QAC/B,KAAK,CAAC,KAAK,IAAI,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,OAAO,IAAI,OAAO,CAAC,KAAK,CAAC,CAAC,CAAA;QAC/D,OAAO,IAAI,CAAA;KACZ;IAEM,KAAK;QACV,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE;YACjB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAA;YACnB,IAAI,CAAC,OAAO,GAAG,IAAI,OAAO,CAAC,CAAC,OAAO,OAAO,IAAI,CAAC,OAAO,GAAG,OAAO,CAAA,EAAE,CAAC,CAAA;YACnE,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,CAAA;YAClB,IAAI,CAAC,OAAO,EAAE,CAAA;SACf;QAED,OAAO,IAAI,CAAA;KACZ;IAEM,IAAI;QACT,IAAI,IAAI,CAAC,OAAO,EAAE;YAChB,IAAI,CAAC,MAAM,EAAE,CAAA;YACb,IAAI,CAAC,OAAQ,EAAE,CAAA;YACf,IAAI,CAAC,OAAO,GAAG,KAAK,CAAA;YACpB,IAAI,CAAC,OAAO,GAAG,QAAQ,CAAA;SACxB;QAED,OAAO,IAAI,CAAA;KACZ;IAEM,KAAK;QACV,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,IAAI,CAAC,CAAA;QACtB,OAAO,IAAI,CAAA;KACZ;;;SCjLa,KAAK,CAAC,QAAgB;IACpC,OAAO,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAA;AAC7B,CAAC;AAED,SAAgB,MAAM,CACpB,QAAgB,EAChB,OAAyC;IAEzC,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAA;AACvC,CAAC;;;;"}