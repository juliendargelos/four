{"version":3,"file":"index.jsm","sources":["../src/record.ts","../src/recordable.ts"],"sourcesContent":["import { Clock } from '@four/clock'\nimport { Loop } from '@four/loop'\n\nclass Record extends Loop {\n  private callback?: (clock: Clock) => Promise<void> | void\n  private started: boolean = false\n  private canceled: boolean = false\n  public maximumDuration: number = Infinity\n\n  public constructor() {\n    super({ interval: 1 })\n  }\n\n  protected async request(): Promise<void> {\n    if (this.canceled) return\n\n    this.tick()\n    await (this.callback && this.callback(this.clock))\n\n    if (\n      (this.empty && this.started) ||\n      this.clock.elapsed >= this.maximumDuration\n    ) {\n      this.stop()\n    } else {\n      await this.request()\n    }\n  }\n\n  protected cancel(): void {\n    this.canceled = true\n  }\n\n  public get empty(): boolean {\n    return !this.handlers.size\n  }\n\n  public get fixed(): boolean {\n    return true\n  }\n\n  public set fixed(fixed: boolean) {\n\n  }\n\n  public start(): this {\n    if (!this.running) {\n      this.canceled = false\n      this.started = false\n    }\n\n    return super.start()\n  }\n\n  public stop(): this {\n    super.stop().handlers.clear()\n    return this\n  }\n\n  public reset({\n    interval = 1,\n    maximumDuration = Infinity,\n    callback = undefined\n  }: {\n    interval?: number\n    maximumDuration?: number\n    callback?: (clock: Clock) => Promise<void> | void\n  } = {}): this {\n    super.reset()\n    this.interval = interval\n    this.maximumDuration = maximumDuration\n    this.callback = callback\n    return this\n  }\n\n  public add(handler: (clock: Clock) => void): this {\n    this.started = true\n    return super.add(handler)\n  }\n}\n\nconst record = new Record()\n\nexport { record as Record }\n","import { Loop } from '@four/loop'\nimport { Record } from './record'\n\nconst delay = Loop.delay\n\nconst { request, cancel } = Loop.prototype as unknown as Loop & {\n  request(): void\n  cancel(): void\n}\n\nclass Recordable extends Loop {\n  private _interval!: number\n  private _fixed!: boolean\n\n  public static delay(duration: number): Promise<void> {\n    return Record.running\n      ? Record.delay(duration)\n      : delay.call(this, duration)\n  }\n\n  public get interval(): number {\n    return Record.running ? Record.interval : this._interval\n  }\n\n  public set interval(interval: number) {\n    this._interval = interval\n  }\n\n  public get fixed(): boolean {\n    return Record.running ? Record.fixed : this._fixed\n  }\n\n  public set fixed(fixed: boolean) {\n    this._fixed = fixed\n  }\n\n  protected request(): void {\n    Record.running\n      ? Record.add(this.handler)\n      : request.call(this)\n  }\n\n  protected cancel(): void {\n    Record.running\n      ? Record.remove(this.handler)\n      : cancel.call(this)\n  }\n}\n\nconst staticProperties = Object.getOwnPropertyDescriptors(Recordable)\nconst properties = Object.getOwnPropertyDescriptors(Recordable.prototype)\n\ndelete staticProperties.prototype\n\nObject.defineProperties(Loop, staticProperties)\nObject.defineProperties(Loop.prototype, properties)\n"],"names":["Record"],"mappings":"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"}